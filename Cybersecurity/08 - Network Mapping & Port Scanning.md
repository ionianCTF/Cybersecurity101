# Cyber Security — Network Mapping & Port Scanning

---

Εάν πρόκειται να υπερασπιστούμε, πρώτα πρέπει να ξέρουμε τι πρέπει να υπερασπιστούμε. Η διαχείριση περιουσιακών στοιχείων (Asset Management) βασίζεται συχνά στο Network Mapping για να εντοπίσει ποια συστήματα είναι ενεργά σε ένα δίκτυο.

Η διαχείριση των περιουσιακών στοιχείων και το να γνωρίζουμε τι εκθέτουμε στο δίκτυο, συμπεριλαμβανομένων των υπηρεσιών που φιλοξενούνται, είναι πολύ σημαντικό για οποιονδήποτε επιθυμεί να υπερασπιστεί το δίκτυό του.

---

## Nmap — The Network Mapper

Το Nmap εδώ και καιρό θεωρείται το πρότυπο εργαλείο σάρωσης θυρών (port scanner) τόσο για δικτυακούς μηχανικούς όσο και για επαγγελματίες ασφάλειας. Μπορούμε να το χρησιμοποιήσουμε για να ανακαλύψουμε περιουσιακά στοιχεία που είτε θα επιτεθούμε είτε θα υπερασπιστούμε.

---

## Network Mapping

Ένας τρόπος για να εντοπίσουμε hosts που είναι ενεργοί στο δίκτυο είναι να στείλουμε ένα ping, δηλαδή ένα ICMP Echo Request, σε όλες τις διευθύνσεις IP του δικτύου. Αυτό αναφέρεται συχνά ως **Ping Sweep**.

![Ping Sweep](https://www.w3schools.com/cybersecurity/img_pingsweep.svg)

Αυτή η προσέγγιση δεν είναι πολύ αποτελεσματική για την ανίχνευση περιουσιακών στοιχείων. Είναι πιθανό ότι τα συστήματα στο δίκτυο θα αγνοήσουν εισερχόμενα pings, ίσως λόγω ενός firewall που τα μπλοκάρει ή λόγω ενός host-based firewall. Ένα host-based firewall είναι απλά ένα firewall που υλοποιείται στο ίδιο το σύστημα αντί για το δίκτυο.

Μια καλύτερη προσέγγιση περιλαμβάνει το να στείλουμε διαφορετικούς τύπους πακέτων σε ένα σύστημα προσδοκώντας κάποια απάντηση για να προσδιορίσουμε αν το σύστημα είναι ζωντανό ή όχι. Για παράδειγμα, το Nmap θα στείλει τα παρακάτω πακέτα στο σύστημα για να προσπαθήσει να προκαλέσει απάντηση:

- ICMP Echo Request
- TCP SYN πακέτο στην πόρτα 443
- TCP ACK πακέτο στην πόρτα 80
- ICMP Timestamp Request

Βάσει των προδιαγραφών του TCP, δηλαδή των κανόνων επικοινωνίας, ένα σύστημα θα πρέπει πάντα να πραγματοποιεί το τριμερές handshake (three-way handshake) πριν ξεκινήσει την επικοινωνία. Το Nmap μοιάζει να παραβιάζει σκόπιμα αυτούς τους κανόνες με τα παραπάνω πακέτα. Μπορείτε να εντοπίσετε ποιο πακέτο δεν συμπεριφέρεται όπως θα ανέμενε ένα σύστημα;

Η αποστολή ενός TCP ACK πακέτου στην πόρτα 80 δεν συμφωνεί με τους κανόνες του προτύπου TCP. Το Nmap το κάνει αυτό συγκεκριμένα για να προσπαθήσει να προκαλέσει μια απάντηση από το σύστημα-στόχο. Για να στείλει πακέτα που δεν ακολουθούν τους κανόνες, το Nmap πρέπει να τρέχει με το υψηλότερο επίπεδο προνομίων, π.χ. ως root ή τοπικός διαχειριστής (administrator). Τα περισσότερα port scanners θα είναι πιο ακριβή εξαιτίας αυτού.

Η απενεργοποίηση του Network Mapping μπορεί να γίνει με την παράμετρο `-Pn`. Το Nmap θα θεωρεί πλέον ότι όλες οι IP/συσκευές είναι "up" και θα προχωρήσει άμεσα στη σάρωση θυρών.

Δοκίμασέ το στο σπίτι αν θέλεις. Προσοχή: εάν βρίσκεσαι σε εταιρικό περιβάλλον, πάντα πάρε άδεια πριν ξεκινήσεις να τρέχεις scanners γιατί δεν θέλεις να παραβιάσεις κανόνες του χώρου εργασίας σου. Για να δοκιμάσεις το Nmap τώρα, ακολούθησε τα παρακάτω βήματα:

- Κατέβασε το Nmap από [https://nmap.org](https://nmap.org). Βεβαιώσου ότι κατεβάζεις την έκδοση που αντιστοιχεί στο λειτουργικό σου σύστημα.
- Εγκατέστησε το Nmap και εκκίνησε το εργαλείο από ένα τερματικό (command line).
- Βρες τη τοπική σου διεύθυνση IP και το subnet.
- Τρέξε το Nmap για να το σαρώσεις και δεις τι είδους συστήματα μπορεί να ανακαλύψει: `nmap -vv IP/netmask`

Προσθέτουμε δύο `-v` για να ζητήσουμε verbose έξοδο από το Nmap — κάνει τη σάρωση πιο "διασκεδαστική" όσο τρέχει.

![Nmap Scan](https://www.w3schools.com/cybersecurity/img_nmap-scan.png)

---

## ARP Scan

Το πρωτόκολλο ARP λειτουργεί εντός ενός LAN, αλλά εάν οι hosts που χρειάζεται να ανακαλύψουμε βρίσκονται στο ίδιο LAN, μπορούμε να χρησιμοποιήσουμε αυτό το πρωτόκολλο για να αποκαλύψουμε συστήματα στο δίκτυο. Επαναλαμβάνοντας τις διαθέσιμες διευθύνσεις IP στο δίκτυο μέσω ARP επιχειρούμε να αναγκάσουμε τα συστήματα να απαντήσουν.

Η σάρωση μοιάζει ως εξής:

```
Eve: Please Provide Mac Address of system 192.168.0.1
Eve: Please Provide Mac Address of system 192.168.0.2
Eve: Please Provide Mac Address of system 192.168.0.3
Eve: Please Provide Mac Address of system 192.168.0.4
Eve: Please Provide Mac Address of system 192.168.0.5-254
Default Gateway: 192.168.0.1 is me and my MAC Address is AA:BB:CC:12:34:56
Bob: 192.168.0.3 is me and my MAC Address is: BB:CC:DD:12:34:56
Alice: 192.168.0.4 is me and my MAC Address is: CC:DD:EE:12:34:56
```

> **Σημείωση:** Η ARP σάρωση είναι απλός και αποτελεσματικός τρόπος για να βρείτε hosts στο LAN, αλλά όχι έξω από το LAN.

---

## Port Scanning

Η σάρωση θυρών (Port Scanning) γίνεται για να προσδιορίσουμε ποιες υπηρεσίες μπορούμε να συνδεθούμε. Κάθε υπηρεσία που «ακούει» παρέχει επιφάνεια επίθεσης (attack surface) η οποία θα μπορούσε να αξιοποιηθεί από επιτιθέμενους. Επομένως είναι σημαντικό να γνωρίζουμε ποιες θύρες είναι ανοιχτές.

Οι επιτιθέμενοι ενδιαφέρονται να μάθουν ποιες εφαρμογές ακούνε στο δίκτυο — αυτές οι εφαρμογές αποτελούν ευκαιρίες για εκμετάλλευση. Μπορεί να υπάρχουν ευπάθειες που τους επιτρέπουν να προσβάλουν επιτυχώς έναν οργανισμό.

Η σάρωση θυρών λειτουργεί στέλνοντας πακέτα σε μια εφαρμογή και παρατηρώντας τυχόν απαντήσεις. Αυτό είναι πολύ εύκολο για το TCP, καθώς αν μια TCP υπηρεσία είναι διαθέσιμη, θα απαντήσει συνήθως με ένα SYN/ACK πακέτο. Για το UDP όμως είναι πιο δύσκολο: ο σαρωτής συνήθως πρέπει να στείλει συγκεκριμένα δεδομένα που θα αναγκάσουν την εφαρμογή να απαντήσει. Οι περισσότερες εφαρμογές που φιλοξενούνται πάνω σε UDP δεν θα απαντήσουν εκτός αν ο πελάτης στείλει ακριβώς τα δεδομένα που απαιτούνται για την επικοινωνία.

---

## TCP Port Scanning

Το TCP είναι εύκολο πρωτόκολλο για σάρωση επειδή το πρότυπο TCP ορίζει ότι τα συστήματα πρέπει να απαντούν με SYN/ACK όταν λαμβάνουν ένα SYN. Μπορούμε να στείλουμε ένα SYN πακέτο σε όλες τις 65.536 θύρες και να καταγράψουμε όλα τα SYN/ACK που επιστρέφονται — τα οποία υποδεικνύουν ποιες θύρες είναι ανοιχτές. Όταν δεν λαμβάνεται απάντηση, μπορούμε να υποθέσουμε ότι η θύρα είναι κλειστή ή φιλτραρισμένη (π.χ. από firewall).

![TCP Scan](https://www.w3schools.com/cybersecurity/img_tcpscan.svg)

Με το SYN/ACK στην πόρτα 445 έχουμε εντοπίσει ότι η θύρα είναι ανοιχτή.

---

## UDP Port Scanning

Με το UDP είναι πιο δύσκολο να προσδιορίσουμε αν μια θύρα είναι ανοιχτή. Για τις UDP θύρες ο σαρωτής δεν μπορεί να βασιστεί σε SYN/ACK. Στην πραγματικότητα, ο σαρωτής σχεδόν πάντα πρέπει να κάνει την εφαρμογή που ακούει να στείλει κάποιο είδος απάντησης.

Με τόσες πολλές πιθανές θύρες ανοιχτές και διαφορετικές υπηρεσίες που απαντούν μόνο στο σωστό είδος δεδομένων, γίνεται χρονοβόρο και δύσκολο να σαρώσουμε όλες τις θύρες σε λογικό χρόνο.

![UDP Scan](https://www.w3schools.com/cybersecurity/img_udpscan.svg)

Η Eve πρέπει να μιλήσει το σωστό πρωτόκολλο και να εξασφαλίσει ότι τα πακέτα φτάνουν στον προορισμό (π.χ. χωρίς απώλεια πακέτων). Διαφορετικά η Eve μπορεί να μην ανακαλύψει ότι η θύρα είναι ανοιχτή.

Εξαιτίας αυτού, η σάρωση UDP μπορεί να είναι πολύ χρονοβόρα αν θέλουμε να σαρώσουμε όλες τις θύρες.

---

## Χρήσιμες τύποι σάρωσης και επιλογές Nmap

Υπάρχουν πολλοί σαρωτές, ωστόσο σε αυτή την ενότητα εστιάζουμε στο πώς να αξιοποιήσουμε το Nmap στο έπακρο.

Το Nmap μπορεί να διατάξει να σαρώσει τις πιο κοινές θύρες με το όρισμα `--top-ports`.

```
nmap --top-ports 100 <target>
```

Ο σαρωτής μπορεί να προσπαθήσει να προσδιορίσει τις εκδόσεις των εφαρμογών που "ακούνε" πίσω από μια θύρα. Αυτό λέγεται service scanning και μπορεί να ενεργοποιηθεί με τη σημαία `-sV`.

```
nmap -sV <target>
```

Το Nmap έχει πολλά ενσωματωμένα scripts που στοχεύουν συγκεκριμένες υπηρεσίες και αλληλεπιδρούν με αυτές. Τα scripts μπορούν να κάνουν διάφορα, όπως να εξάγουν πληροφορίες από την υπηρεσία ή να προσπαθήσουν να την εκμεταλλευτούν. Μπορούμε να ενεργοποιήσουμε το script scanner με τη σημαία `-sC`. Αυτό ενεργοποιεί μόνο ασφαλείς ελέγχους (safe checks), επομένως δεν προσπαθεί για denial of service ή εκμετάλλευση.

```
nmap -sC <target>
```

Η ανίχνευση λειτουργικού συστήματος (Operating System detection) μπορεί να γίνει με το σαρωτή, επιτρέποντάς του να προσπαθήσει να προσδιορίσει ποιο λειτουργικό σύστημα τρέχει. Χρησιμοποιεί πολλά διαφορετικά χαρακτηριστικά για να μετρήσει και να εκτιμήσει την πιθανότητα. Αυτό μπορεί να ενεργοποιηθεί με την παράμετρο `-O`.

```
nmap -O <target>
```

Η επιθετική λειτουργία (aggressive mode) του Nmap ενεργοποιεί πολλές σημαίες ταυτόχρονα. Ο σαρωτής θα κάνει ανίχνευση έκδοσης και λειτουργικού, θα ενεργοποιήσει το script scanner και θα σαρώσει τις 1000 πιο κοινές θύρες. Αυτό μπορεί να ενεργοποιηθεί με την επιλογή `-A`.

```
nmap -A <target>
```

Το Nmap μπορεί επίσης να σαρώσει IPv6 σε όλες τις παραπάνω επιλογές με την προσθήκη της παραμέτρου `-6`.

```
nmap -6 <target>
```

> **Σημείωση:** Ο πιο αποτελεσματικός τρόπος για να κατανοήσεις είναι να εξασκηθείς και να αποκτήσεις πρακτική εμπειρία. Κατέβασε το Nmap και δοκίμασε αυτές τις διαφορετικές σαρώσεις σε συστήματα στο δικό σου περιβάλλον!

---

## Επιλογές χρονοπρογραμματισμού (Timing) του Nmap

Η σάρωση μπορεί να γίνει με διαφορετικές ταχύτητες. Πιο αργές σάρωσεις έχουν μικρότερη πιθανότητα να εντοπιστούν από συστήματα IDS, ενώ μια γρήγορη σάρωση μπορεί να υπερφορτώσει το σύστημα. Το Nmap υποστηρίζει τις ακόλουθες επιλογές:

- `T0` — Paranoid. Αυτή η επιλογή είναι για επιτιθέμενους που δεν θέλουν να εντοπιστούν. Τα IDS μπορούν να συσχετίσουν πολλαπλά αιτήματα μέσα σε συγκεκριμένα χρονικά διαστήματα. Η paranoid επιλογή θα προσπαθήσει να το αποφύγει αυτό αποστέλλοντας πολύ λίγα πακέτα ανά δευτερόλεπτο.
- `T1` — Sneaky. Ταχύτερο αλλά σχεδιασμένο για να αποφύγει συστήματα IDS.
- `T2` — Polite. Αργή σάρωση που προσπαθεί να μην καταρρίψει ένα σύστημα.
- `T3` — Normal. Απλά η προεπιλογή.
- `T4` — Aggressive. Γρήγορη σάρωση που δίνει γρήγορα αποτελέσματα. Τα περισσότερα συστήματα μπορούν να το αντέξουν.
- `T5` — Insane. Στέλνουμε στο μέγιστο ρυθμό και απόδοση.

---

## Zenmap

Το Nmap διαθέτει ένα ενσωματωμένο GUI (Graphical User Interface), μαζί με άλλα εργαλεία. Το GUI μπορεί να είναι χρήσιμο για την οπτικοποίηση δικτύων και την περιήγηση σε ανοιχτές θύρες ανάμεσα σε διαφορετικούς hosts. Το GUI μοιάζει με την παρακάτω εικόνα:

![Zenmap](img_zenmap.png)

---
